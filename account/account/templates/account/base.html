{% load static %}
<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>{% block title-meta %}داشبورد{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="{% static 'registration/adminlte/plugins/fontawesome-free/css/all.min.css' %}">
  <!-- AdminLTE -->
  <link rel="stylesheet" href="{% static 'registration/adminlte/assets/css/adminlte.min.css' %}">
  <!-- JQVMap -->
  <link rel="stylesheet" href="{% static 'registration/adminlte/plugins/jqvmap/jqvmap.min.css' %}">
  <!-- OverlayScrollbars -->
  <link rel="stylesheet" href="{% static 'registration/adminlte/plugins/overlayScrollbars/css/OverlayScrollbars.min.css' %}">
  <!-- Bootstrap RTL -->
  <link rel="stylesheet" href="https://cdn.rtlcss.com/bootstrap/v4.2.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
  <!-- Custom -->
  <link rel="stylesheet" href="{% static 'registration/adminlte/assets/css/custom.css' %}">

  <!-- فونت‌ها - بدون crossorigin برای رفع بلوک visibility -->
  <style>
    @font-face {
      font-family: 'Sahel';
      src: url('{% static "font/Sahel.ttf" %}') format('truetype');
    }
    @font-face {
      font-family: 'B Titr';
      src: url('{% static "fonts/B-Titr.woff2" %}') format('woff2'),
           url('{% static "fonts/B-Titr.woff" %}') format('woff');
      font-display: swap;
    }
    body {
      font-family: 'B Titr', 'Sahel', sans-serif;
      direction: rtl;
      text-align: right;
    }
  </style>

  <!-- Quill CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

  <!-- نوار بالایی -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="{% url 'account:home' %}" class="nav-link">صفحه اصلی</a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="{% url 'home:home' %}" target="_blank" class="nav-link">نمایش سایت</a>
      </li>
    </ul>
  </nav>

  <!-- سایدبار -->
  {% include 'inc/sidebar.html' %}

  <!-- محتوای اصلی -->
  <div class="content-wrapper">
    <section class="content pt-3">
      <div class="container-fluid">
        {% block main %}
        <h1 class="mb-4">داشبورد - مدیریت مقالات</h1>

        <!-- فرم مقاله (برای مثال) -->
        <div class="row">
          <div class="col-md-12">
            <div class="card card-primary">
              <div class="card-header">
                <h3 class="card-title">ایجاد/ویرایش مقاله</h3>
              </div>
              <form method="post">
                {% csrf_token %}
                <div class="card-body">
                  <div class="form-group">
                    <label for="{{ form.title.id_for_label }}">عنوان مقاله</label>
                    {{ form.title }}
                  </div>
                  <div class="form-group">
                    <label for="{{ form.slug.id_for_label }}">اسلاگ</label>
                    {{ form.slug }}
                  </div>
                  <div class="form-group">
                    <label for="{{ form.category.id_for_label }}">دسته‌بندی</label>
                    {{ form.category }}
                  </div>
                  <div class="form-group">
                    <label for="{{ form.description.id_for_label }}">محتوا</label>
                    <div id="editor-container" style="height: 300px; background: #fff; border: 1px solid #ccc;">
                      <!-- QuillField به عنوان textarea رندر می‌شود -->
                      {{ form.description }}
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="{{ form.thumbnail.id_for_label }}">تصویر</label>
                    {{ form.thumbnail }}
                  </div>
                  <div class="form-group">
                    <label for="{{ form.status.id_for_label }}">وضعیت</label>
                    {{ form.status }}
                  </div>
                  <div class="form-group">
                    <label for="{{ form.is_special.id_for_label }}">مقاله ویژه</label>
                    {{ form.is_special }}
                  </div>
                  <div class="form-group">
                    <label for="{{ form.video.id_for_label }}">ویدیو</label>
                    {{ form.video }}
                  </div>
                </div>
                <div class="card-footer">
                  <button type="submit" class="btn btn-primary">ذخیره</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- المان‌های داشبورد (بهبود یافته برای رفع خطاهای JS) -->
        <div class="row">
          <div class="col-lg-3 col-6">
            <!-- Sparkline - با div خالی برای innerHTML -->
            <div class="small-box bg-info">
              <div class="inner">
                <h3><span id="sparkline-1"></span></h3>
                <p>تعداد مقالات</p>
              </div>
              <div class="icon">
                <i class="fas fa-file-alt"></i>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-6">
            <div class="small-box bg-success">
              <div class="inner">
                <h3>۵۳<sup style="font-size: 20px">%</sup></h3>
                <p>نرخ انتشار</p>
              </div>
              <div class="icon">
                <i class="fas fa-chart-line"></i>
              </div>
            </div>
          </div>
          <!-- ادامه باکس‌ها اگر نیاز داری -->
        </div>

        <!-- نقشه جهان (با ابعاد ثابت برای JQVMap) -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">نقشه بازدیدها</h3>
              </div>
              <div class="card-body">
                <div id="world-map" style="width: 600px; height: 400px;"></div>
              </div>
            </div>
          </div>
        </div>

        {% endblock %}
      </div>
    </section>
  </div>

  <!-- فوتر -->
  <footer class="main-footer text-center">
    <strong>کانون وکلای دادگستری استان همدان</strong>
  </footer>
</div>

<!-- ==== Scripts ==== -->
<script src="{% static 'registration/adminlte/plugins/jquery/jquery.min.js' %}"></script>
<script src="{% static 'registration/adminlte/plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'registration/adminlte/plugins/jquery-ui/jquery-ui.min.js' %}"></script>
<script>$.widget.bridge('uibutton', $.ui.button)</script>
<script src="{% static 'registration/adminlte/plugins/moment/moment-with-locales.min.js' %}"></script>
<script src="{% static 'registration/adminlte/plugins/daterangepicker/daterangepicker.js' %}"></script>
<script src="{% static 'registration/adminlte/plugins/sparklines/sparkline.js' %}"></script>
<script src="{% static 'registration/adminlte/plugins/jqvmap/jquery.vmap.min.js' %}"></script>
<script src="{% static 'registration/adminlte/plugins/jqvmap/maps/jquery.vmap.world.js' %}"></script>
<script src="{% static 'registration/adminlte/plugins/jquery-knob/jquery.knob.min.js' %}"></script>
<script src="{% static 'registration/adminlte/assets/js/adminlte.min.js' %}"></script>

<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<!-- Dashboard JS - اگر لود می‌شه، اما برای رفع Summernote -->
<script src="{% static 'registration/adminlte/assets/js/pages/dashboard.js' %}"></script>

<script>
$(function () {

  // Knob (اگر المانی داری)
  if ($.fn.knob) {
    $(".knob").each(function(){
      try { $(this).knob(); } catch(e){ console.warn("Knob error:", e); }
    });
  }

  // Sparkline - با چک دقیق‌تر
  if ($.fn.sparkline && $('#sparkline-1').length && $('#sparkline-1').is('span')){
    try {
      $('#sparkline-1').sparkline([5,6,7,2,0,-4,-2,4], { type: 'bar' });
    } catch(e){ console.warn("Sparkline error:", e); }
  } else {
    console.warn('Sparkline element not ready or not span');
  }

  // JQVMap - با ابعاد ثابت
  if ($.fn.vectorMap && $('#world-map').length){
    try {
      $('#world-map').vectorMap({
        map: 'world_en',
        backgroundColor: 'transparent',
        width: 600,
        height: 400,
      });
    } catch(e){ console.warn("jqvmap error:", e); }
  }

  // Date Range (اگر المانی داری)
  if ($.fn.daterangepicker) {
    $('.daterange').each(function(){ $(this).daterangepicker(); });
  }

  // Quill Editor (initialize روی textarea داخل container)
  var editorContainer = document.getElementById('editor-container');
  if (editorContainer){
    var quill = new Quill(editorContainer, {
      theme: 'snow',
      placeholder: 'متن خود را اینجا بنویسید'
    });
    // اگر مقدار اولیه وجود داره، set کن (برای ویرایش) - فرض QuillField delta JSON
    var textarea = editorContainer.querySelector('textarea');
    if (textarea && textarea.value) {
      try {
        var delta = JSON.parse(textarea.value);
        quill.setContents(delta);
      } catch(e) {
        quill.setText(textarea.value); // fallback به text
      }
    }
    // برای submit، delta رو به textarea بریز
    quill.on('text-change', function() {
      var delta = quill.getContents();
      textarea.value = JSON.stringify(delta);
    });
  }

  // رفع Summernote از dashboard.js - override initialize
  if (typeof $.fn.summernote !== 'undefined') {
    if ($('.summernote').length > 0) {
      $('.summernote').summernote();
    } else {
      console.log('No summernote elements found, skipping init');
    }
  } else {
    console.log('Summernote library not loaded, skipping init');
  }
});
</script>

{% block extra_js %}{% endblock %}
</body>
</html>

