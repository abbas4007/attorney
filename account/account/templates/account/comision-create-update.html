{% extends 'account/base.html' %}
{% load static %}
{% block headers %}
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>{% block title-meta %}{% if form.instance.id %}ویرایش{% else %}ایجاد{% endif %} کمیسیون | سامانه وکلا{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="{% static 'registration/adminlte/plugins/fontawesome-free/css/all.min.css' %}">
  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <!-- Custom CSS -->
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --accent-color: #4895ef;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --success-color: #4cc9f0;
      --border-radius: 8px;
      --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    .comission-form {
      background: #ffffff;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 2rem;
      margin: 2rem auto;
      border-top: 4px solid var(--primary-color);
      transition: var(--transition);
    }

    .comission-form:hover {
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.12);
    }

    .form-header {
      border-bottom: 1px solid #e9ecef;
      padding-bottom: 1.2rem;
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
    }

    .form-header h3 {
      color: var(--primary-color);
      font-weight: 700;
      font-size: 1.5rem;
      margin: 0;
      display: flex;
      align-items: center;
    }

    .form-header i {
      font-size: 1.8rem;
      margin-left: 0.8rem;
      color: var(--accent-color);
    }

    .form-group {
      margin-bottom: 1.8rem;
      position: relative;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.6rem;
      font-weight: 600;
      color: var(--dark-color);
      font-size: 0.95rem;
    }

    .form-control {
      display: block;
      width: 100%;
      padding: 0.65rem 1rem;
      font-size: 1rem;
      font-weight: 400;
      line-height: 1.5;
      color: #495057;
      background-color: #fff;
      background-clip: padding-box;
      border: 1px solid #ced4da;
      border-radius: var(--border-radius);
      transition: var(--transition);
      box-shadow: none;
    }

    .form-control:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
    }

    .help-text {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 0.4rem;
      font-style: italic;
    }

    .form-footer {
      margin-top: 2.5rem;
      display: flex;
      justify-content: center;
      gap: 1rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      text-align: center;
      white-space: nowrap;
      vertical-align: middle;
      user-select: none;
      border: 1px solid transparent;
      padding: 0.65rem 1.75rem;
      font-size: 1rem;
      line-height: 1.5;
      border-radius: var(--border-radius);
      transition: var(--transition);
      cursor: pointer;
    }

    .btn-primary {
      color: #fff;
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-primary:hover {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
      transform: translateY(-2px);
    }

    .btn-light {
      color: var(--dark-color);
      background-color: #f8f9fa;
      border-color: #f8f9fa;
    }

    .btn-light:hover {
      background-color: #e2e6ea;
      border-color: #dae0e5;
      transform: translateY(-2px);
    }

    /* Select2 Custom Styles */
    .select2-container--default .select2-selection--multiple {
      min-height: 42px;
      border: 1px solid #ced4da !important;
      border-radius: var(--border-radius) !important;
      transition: var(--transition);
    }

    .select2-container--default .select2-selection--multiple .select2-selection__choice {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
      padding: 0 0.5rem 0 1.5rem;
      margin-top: 0.4rem;
      position: relative;
      border-radius: 12px;
    }

    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
      color: rgba(255,255,255,0.7);
      position: absolute;
      right: auto;
      left: 0.3rem;
      top: 50%;
      transform: translateY(-50%);
    }

    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
      color: white;
    }

    .select2-container--default .select2-selection--single {
      height: 42px;
      border: 1px solid #ced4da !important;
      border-radius: var(--border-radius) !important;
      transition: var(--transition);
    }

    .select2-container--default.select2-container--focus .select2-selection--multiple,
    .select2-container--default.select2-container--focus .select2-selection--single {
      border-color: var(--accent-color) !important;
      box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
    }

    .select2-container--default .select2-results__option--highlighted[aria-selected] {
      background-color: var(--primary-color);
    }

    /* Style for license number in dropdown */
    .select2-results__option small {
      display: block;
      color: #6c757d;
      font-size: 0.85em;
      margin-top: 2px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .comission-form {
        padding: 1.5rem;
        margin: 1rem auto;
      }

      .form-footer {
        flex-direction: column;
        gap: 0.75rem;
      }

      .btn {
        width: 100%;
      }
    }
  </style>
</head>
{% endblock %}

{% block content %}

<div class="content-wrapper">
  <section class="content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-8 mx-auto">
          <div class="comission-form">
            <div class="form-header">
              <i class="fas fa-users-cog"></i>
              <h3>
                {% if form.instance.id %}ویرایش کمیسیون {{ form.instance.name }}{% else %}ایجاد کمیسیون جدید{% endif %}
              </h3>
            </div>

            <form method="post" id="comissionForm">
              {% csrf_token %}

              <div class="form-group">
                <label for="id_name">نام کمیسیون</label>
                <input type="text" name="name" id="id_name"
                       class="form-control {% if form.name.errors %}is-invalid{% endif %}"
                       value="{{ form.name.value|default:'' }}" required
                       placeholder="مثال: کمیسیون حقوقی">
                {% if form.name.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.name.errors.0 }}
                  </div>
                {% endif %}
                <p class="help-text">نام رسمی کمیسیون را به صورت کامل وارد نمایید</p>
              </div>

              <div class="form-group">
                <label for="id_vakils">اعضای کمیسیون</label>
                <select id="id_vakils" name="vakils" class="form-control" multiple="multiple">
                  {% for vakil in form.vakils.field.queryset %}
                    <option value="{{ vakil.id }}"
                      {% if vakil in commission.vakils.all or vakil.id in form.vakils.value %}selected{% endif %}>
                      {{ vakil.name }} {{ vakil.lastname }} - شماره پروانه: {{ vakil.code }} (تخصص: {{ vakil.get_expertise_display }})
                    </option>
                  {% endfor %}
                </select>
                <p class="help-text">می‌توانید چند عضو را انتخاب کنید</p>
              </div>

              <div class="form-group">
                <label for="id_chairman">رئیس کمیسیون</label>
                <select id="id_chairman" name="chairman" class="form-control" required>
                  <option value="">-- انتخاب کنید --</option>
                  {% for member in commission.vakils.all %}
                    <option value="{{ member.id }}"
                      {% if member.id == commission.chairman.id %}selected{% endif %}>
                      {{ member.name }} {{ member.lastname }} - شماره پروانه: {{ member.code }}
                    </option>
                  {% endfor %}
                </select>
                <p class="help-text">لطفاً رئیس را از بین اعضای انتخاب شده مشخص کنید</p>
              </div>

              <div class="form-footer">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save mr-2"></i>ذخیره تغییرات
                </button>
                <a href="{% url 'account:comision' %}" class="btn btn-light">
                  <i class="fas fa-times mr-2"></i>انصراف
                </a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- Persian Language for Select2 -->
<script src="{% static 'registration/adminlte/plugins/select2/i18n/fa.js' %}"></script>
<!-- Custom JS -->
<script>
$(document).ready(function() {
  // Initialize Select2 for members
  $('#id_vakils').select2({
    placeholder: "اعضای کمیسیون را انتخاب کنید",
    allowClear: true,
    dir: "rtl",
    width: '100%',
    language: 'fa',
    minimumInputLength: 0,
    closeOnSelect: false,
    templateResult: formatMember,
    templateSelection: formatMemberSelection,
    escapeMarkup: function(markup) { return markup; }
  });

  // Initialize Select2 for chairman
  $('#id_chairman').select2({
    placeholder: "رئیس کمیسیون را انتخاب کنید",
    allowClear: true,
    dir: "rtl",
    width: '100%',
    language: 'fa',
    templateResult: formatChairman,
    templateSelection: formatChairmanSelection,
    escapeMarkup: function(markup) { return markup; }
  });

  // Function to format member display in dropdown
  function formatMember(member) {
    if (!member.id) { return member.text; }

    var text = member.text;
    var parts = text.split('(');
    var mainText = parts[0].trim();
    var details = parts.length > 1 ? parts[1].replace(')', '').trim() : '';

    var $member = $(
      '<div>' +
      '<strong>' + mainText + '</strong>' +
      '<small class="text-muted d-block">' + details + '</small>' +
      '</div>'
    );
    return $member;
  }

  // Function to format selected member display
  function formatMemberSelection(member) {
    return member.text.split('(')[0].trim();
  }

  // Function to format chairman display in dropdown
  function formatChairman(chairman) {
    if (!chairman.id) { return chairman.text; }

    var text = chairman.text;
    var parts = text.split('-');
    var name = parts[0].trim();
    var license = parts.length > 1 ? parts[1].trim() : '';

    var $chairman = $(
      '<div>' +
      '<strong>' + name + '</strong>' +
      '<small class="text-muted d-block">' + license + '</small>' +
      '</div>'
    );
    return $chairman;
  }

  // Function to format selected chairman display
  function formatChairmanSelection(chairman) {
    return chairman.text.split('-')[0].trim();
  }

  // Update chairman dropdown when members change
  $('#id_vakils').on('change', function() {
    var selectedMembers = $(this).val();
    var chairmanSelect = $('#id_chairman');

    // Clear and add default option
    chairmanSelect.empty().append('<option value="">-- انتخاب کنید --</option>');

    if (selectedMembers && selectedMembers.length > 0) {
      // Get selected members data
      var membersData = $('#id_vakils').select2('data');

      // Add options for selected members
      membersData.forEach(function(member) {
        var isSelected = (member.id == '{{ commission.chairman.id|default:"" }}');
        // Extract name and license number from member text
        var memberText = member.text;
        var namePart = memberText.split('(')[0].trim();
        var licensePart = memberText.split('شماره پروانه:')[1].split(')')[0].trim();
        var displayText = namePart + ' - شماره پروانه: ' + licensePart;

        chairmanSelect.append(new Option(displayText, member.id, false, isSelected));
      });
    }
  });

  // Trigger change event on page load if there are selected members
  if ($('#id_vakils').val()) {
    $('#id_vakils').trigger('change');
  }
});
</script>
{% endblock %}